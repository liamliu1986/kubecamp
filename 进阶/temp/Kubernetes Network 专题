Kubernetes Network 专题

实验环境：
kube01  10.10.100.133   master      10.111.0.0/24
kube02  10.10.100.134   worker      10.111.1.0/24
kube03  10.10.100.135   worker      10.111.2.0/24

POD_CIDR=10.111.0.0/16 
CLUTERIP=10.112.0.0/16 

部署flannel网络插件

kubernetes网络模型：
1. POD to POD 间的通信，是不通过NAT
2. 宿主机到POD访问，不通过NAT
3. POD要有自己独立的网络空间

实现以上要就：
1. namespaces
2. veth pair
3. netfilter(PRE_ROUTING,LOCAL_INPUT,FORWARD,LOCAL_OUTPUT,POST_ROUTING)
4. 网桥
5. 路由


容器网络应用场景：
    1. container to container 
    2. 相同节点POD to POD 
    3. 跨节点POD to POD 
    4. 物理网络与POD的通信

    container到container
        namespace 隔离网络协议栈：
            1. 路由表
            2. 防火墙
            3. 网络设备
            4. loopback device

        POD内的container共享同一个netns

        实验： twocontainerpod.yaml

    POD to POD :
        相同节点：
        跨节点：

        实验：deployment-ex.yaml


Flannel 
    后端实现：
        - VXLAN，推荐使用，UDP封装，性能损耗，可以跨子网
        - host-gw, 不封装，无损耗，跨子网可能存在问题
        - UDP，不推荐，Debug



ServieIP--CLUTERIP

POD to Egress 


Calico

WHAT

    SDN解决方案
    特性：
        1. 灵活，随处可运行的安全措施
        2. 内核级性能
        3. 高可伸缩

WHY
    1. 强安全策略模型，策略引擎支持主机网络和服务网络
    2. calico性能卓越，提供内核级别的转发和访问能力，一般不进行封包解包流程
    3. 云原生机制，扩展性良好
    4. k8s原生的networking policy 和非k8s策略进行互动
    5. 多数情况非封装非覆盖的网络，使得流量追踪
    6. kubernetes netowrking支持


    组成：
        1. calico CNI，提供了一些RestAPI，供kubelet

        2. Calico Node:
            - Felix：
                接口和路由管理
                状态报告
                强制策略
            - BIRD
                策略分发

        3. confid:
            配置管理

    机制：

        部署calico之后，网卡变化

            [root@kube01 ~]# ip link ls

            6: cali8ff83a55cce@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1480 qdisc noqueue state UP mode DEFAULT group default 
                link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid 0
            7: cali93274caaa80@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP mode DEFAULT group default 
                link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netnsid 1
            8: vxlan.calico: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default 
                link/ether 66:5b:2b:b8:df:0c brd ff:ff:ff:ff:ff:ff

            [root@kube01 ~]# ip route

            10.111.34.1 dev cali8ff83a55cce scope link 
            10.111.34.2 dev cali93274caaa80 scope link 
            10.111.87.0/24 via 10.10.100.134 dev ens33 proto 80 onlink 
            10.111.164.0/24 via 10.10.100.135 dev ens33 proto 80 onlink 
 

        1. calico 不创建网桥，而是通过路由表实现POD的通信
        2. Node都被视为边界路由，开启BGP，kubernetes集群从而形成一个node-to-node mesh的全联通拓扑结构
        3. 随节点数增加，连接数以N的平方增长，会对集群网络产生巨大影响，一般情况下，官方建议100节点

        router reflector


部署Calico

github上下载calicoctl


网络选择
    三种模型：
        1. overlay
        2. 3 layer route table
        3. underlay

    calico 网络：
        IPAM POD IP
        编写路由表
        将路由表分发集群其他节点或者物理网络设备


    网络选项                                环境                         性能            复杂度
    calico,不封装，和物理网络配对             本地部署                      Best            中等                允许POD从集群外直接访问
    calico，不封装，不与物理网络配对           本地部署                      Best            低                  ipip/vxlan crosssubnet
    calico，封装IPIP                        本地，大部分的共有云            硬件            低
    calico，封装vxlan                       本地，大部分的共有云            硬件            低
    flannels                              任何环境                      性能稍差          中等